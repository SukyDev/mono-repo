# This file contains the fastlane.tools configuration
# You can find the documentation at https://docs.fastlane.tools
#
# For a list of all available actions, check out
#
#     https://docs.fastlane.tools/actions
#
# For a list of all available plugins, check out
#
#     https://docs.fastlane.tools/plugins/available-plugins
#

# Uncomment the line if you want fastlane to automatically update itself
# update_fastlane

# Apps/CiCdTesting/CiCdTesting/CiCdTesting/fastlane/Fastfile

default_platform(:ios)

platform :ios do
  before_all do
    setup_ci if ENV['CI']
  end

  desc "Run tests with code coverage"
  lane :test do |options|
    # Get device ID from environment (should be set by CI)
    device_id = ENV['DEVICE_ID']
    
    if device_id && !device_id.empty?
      destination = "platform=iOS Simulator,id=#{device_id}"
      UI.important "üéØ Using specific device ID: #{device_id}"
    else
      # Fallback: find or create iPhone SE
      UI.important "‚ö†Ô∏è  No DEVICE_ID provided, searching for iPhone SE..."
      
      # List available simulators
      simulators = `xcrun simctl list devices available`.lines
      iphone_se = simulators.find { |line| line.include?("iPhone SE (3rd generation)") && line.include?("18.4") }
      
      if iphone_se
        # Extract UUID from the line
        device_id = iphone_se[/([A-F0-9-]{36})/, 1]
        destination = "platform=iOS Simulator,id=#{device_id}"
        UI.success "Found existing iPhone SE: #{device_id}"
      else
        UI.user_error! "‚ùå No iPhone SE (3rd generation) with iOS 18.4 found and no DEVICE_ID provided"
      end
    end
    
    UI.important "üì± Final destination: #{destination}"
    
    scan(
      project: "CiCdTesting.xcodeproj",
      scheme: "CiCdTesting",
      testplan: "CiCdTesting",
      destination: destination,
      only_testing: ["ContentViewTests"],
      code_coverage: true,
      result_bundle: true,
      output_directory: ".",
      buildlog_path: ".",
      clean: true,
      parallel_testing: false,
      derived_data_path: "DerivedData",
      skip_build: false,
      reset_simulator: false
    )
  end

  desc "Generate code coverage report with xcov"
  lane :coverage do |options|
    minimum_coverage = options[:minimum_coverage] || 20.0
    
    # xcov needs the xcresult bundle path
    result_bundle_path = File.expand_path("./test_output/CiCdTesting.xcresult")
    
    unless File.exist?(result_bundle_path)
      UI.user_error! "‚ùå Test results not found at #{result_bundle_path}. Did you run tests first?"
    end
    
    UI.important "üìä Generating coverage report from: #{result_bundle_path}"
    
    xcov(
      scheme: "CiCdTesting",
      project: "CiCdTesting.xcodeproj",
      output_directory: "coverage_report",
      json_report: true,
      html_report: true,
      markdown_report: true,
      minimum_coverage_percentage: minimum_coverage,
      include_test_targets: false,
      only_project_targets: true,
      derived_data_path: "DerivedData"
    )
    
    # Read the coverage percentage from xcov's output
    coverage_file = "coverage_report/index.json"
    if File.exist?(coverage_file)
      require 'json'
      data = JSON.parse(File.read(coverage_file))
      coverage = data['coverage']
      
      UI.success "üìä Code Coverage: #{coverage}%"
      
      if coverage < minimum_coverage
        UI.user_error! "‚ùå Code coverage (#{coverage}%) is below threshold (#{minimum_coverage}%)"
      else
        UI.success "‚úÖ Code coverage meets threshold!"
      end
      
      # Export for GitHub Actions
      if ENV['GITHUB_OUTPUT']
        File.open(ENV['GITHUB_OUTPUT'], 'a') do |f|
          f.puts "coverage=#{coverage}"
        end
      end
    else
      UI.warning "‚ö†Ô∏è  Could not find coverage JSON file at #{coverage_file}"
    end
  end

  desc "Run tests and generate coverage report"
  lane :test_with_coverage do |options|
    test(options)
    coverage(options)
  end

  desc "Build app for release"
  lane :build do
    clear_derived_data
    
    spm(
      command: "resolve",
      project: "CiCdTesting.xcodeproj"
    )
    
    gym(
      project: "CiCdTesting.xcodeproj",
      scheme: "CiCdTesting",
      export_method: "app-store",
      export_options: "exportOptions.plist",
      output_directory: "build",
      output_name: "CiCdTesting.ipa",
      clean: true,
      derived_data_path: "DerivedData",
      build_path: "build",
      archive_path: "build/CiCdTesting.xcarchive",
      skip_package_ipa: false,
      xcargs: "SKIP_INSTALL=NO BUILD_LIBRARY_FOR_DISTRIBUTION=YES OTHER_SWIFT_FLAGS=\"-enable-experimental-prebuilts\""
    )
  end

  desc "Upload to App Store Connect"
  lane :upload_to_testflight do
    api_key = app_store_connect_api_key(
      key_id: ENV['API_KEY'],
      issuer_id: ENV['ISSUER_ID'],
      key_filepath: "#{Dir.home}/private_keys/AuthKey_#{ENV['API_KEY']}.p8"
    )
    
    pilot(
      api_key: api_key,
      ipa: "build/CiCdTesting.ipa",
      skip_waiting_for_build_processing: true
    )
  end

  desc "Full release process: build and upload"
  lane :release do
    build
    upload_to_testflight
  end
end