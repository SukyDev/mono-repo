name: iOS CI

on:
  pull_request:
    branches: [ main, development ]
  push:
    branches: [ main, development ]
  workflow_dispatch:

jobs:
  detect-changes:
    runs-on: ubuntu-latest
    outputs:
      cicdtesting: ${{ steps.filter.outputs.cicdtesting }}
      cicdtestingdev: ${{ steps.filter.outputs.cicdtestingdev }}
      commonpackage: ${{ steps.filter.outputs.commonpackage }}
      workflow-changed: ${{ steps.filter.outputs.workflow }}
    steps:
      - uses: actions/checkout@v4
        with:
          fetch-depth: 0
      - uses: dorny/paths-filter@v2
        id: filter
        with:
          filters: |
            cicdtesting:
              - 'Apps/CiCdTesting/**'
            cicdtestingdev:
              - 'Apps/CiCdTestingDev/**'
            commonpackage:
              - 'CommonPackage/**'
            workflow:
              - '.github/workflows/**'

  tests:
    needs: detect-changes
    if: needs.detect-changes.outputs.cicdtesting == 'true' || needs.detect-changes.outputs.cicdtestingdev == 'true' || needs.detect-changes.outputs.commonpackage == 'true' || needs.detect-changes.outputs.workflow-changed == 'true'
    runs-on: macos-latest

    strategy:
      matrix:
        include:
          - name: CiCdTesting
            folder: Apps/CiCdTesting/CiCdTesting/CiCdTesting
            project_file: CiCdTesting.xcodeproj
            scheme: CiCdTesting
            package_name: cicd-ios
            test_target: ContentViewTests
          - name: CiCdTestingDev
            folder: Apps/CiCdTestingDev/CiCdTestingDev/CiCdTestingDev
            project_file: CiCdTestingDev.xcodeproj
            scheme: CiCdTestingDev
            package_name: cicddev-ios
            test_target: ContentViewTests

    steps:
      - uses: actions/checkout@v4

      - name: Check if project should run
        id: check
        run: |
          # Check if CommonPackage or workflow changed (run all projects)
          if [ "${{ needs.detect-changes.outputs.commonpackage }}" == "true" ] || [ "${{ needs.detect-changes.outputs.workflow-changed }}" == "true" ]; then
            echo "CommonPackage or workflow changed - running all projects"
            echo "skip=false" >> $GITHUB_OUTPUT
            exit 0
          fi
          
          # Check if this specific project changed
          if [ "${{ matrix.name }}" == "CiCdTesting" ] && [ "${{ needs.detect-changes.outputs.cicdtesting }}" == "true" ]; then
            echo "CiCdTesting changed - running tests"
            echo "skip=false" >> $GITHUB_OUTPUT
            exit 0
          fi
          
          if [ "${{ matrix.name }}" == "CiCdTestingDev" ] && [ "${{ needs.detect-changes.outputs.cicdtestingdev }}" == "true" ]; then
            echo "CiCdTestingDev changed - running tests"
            echo "skip=false" >> $GITHUB_OUTPUT
            exit 0
          fi
          
          # Otherwise skip
          echo "Project ${{ matrix.name }} did not change - skipping"
          echo "skip=true" >> $GITHUB_OUTPUT

      - name: Select Xcode
        if: steps.check.outputs.skip != 'true'
        uses: maxim-lobanov/setup-xcode@v1
        with:
          xcode-version: '16.2.0'

      - name: Run Reducer Tests
        if: steps.check.outputs.skip != 'true'
        run: |
          cd ${{ matrix.folder }}
          set -o pipefail
          xcodebuild -skipMacroValidation test \
            -project ${{ matrix.project_file }} \
            -scheme ${{ matrix.scheme }} \
            -destination 'platform=iOS Simulator,name=iPhone SE (3rd generation),OS=18.4' \
            -only-testing:${{ matrix.test_target }} \
            clean test | xcpretty

  collect-tested:
    needs: [detect-changes, tests]
    if: success()
    runs-on: ubuntu-latest
    outputs:
      tested-projects: ${{ steps.collect.outputs.tested-projects }}
      has-projects: ${{ steps.collect.outputs.has-projects }}
    steps:
      - name: Debug outputs
        run: |
          echo "cicdtesting output: '${{ needs.detect-changes.outputs.cicdtesting }}'"
          echo "cicdtestingdev output: '${{ needs.detect-changes.outputs.cicdtestingdev }}'"
          echo "commonpackage output: '${{ needs.detect-changes.outputs.commonpackage }}'"
          echo "workflow-changed output: '${{ needs.detect-changes.outputs.workflow-changed }}'"
      
      - name: Collect tested projects
        id: collect
        run: |
          projects="[]"
          
          echo "Initial projects: $projects"
          
          # If CommonPackage or workflow changed, add all projects
          if [ "${{ needs.detect-changes.outputs.commonpackage }}" == "true" ] || [ "${{ needs.detect-changes.outputs.workflow-changed }}" == "true" ]; then
            echo "CommonPackage or workflow changed, adding all projects"
            projects='[{"name":"CiCdTesting","folder":"Apps/CiCdTesting/CiCdTesting/CiCdTesting","project_file":"CiCdTesting.xcodeproj","scheme":"CiCdTesting","package_name":"cicd-ios"},{"name":"CiCdTestingDev","folder":"Apps/CiCdTestingDev/CiCdTestingDev/CiCdTestingDev","project_file":"CiCdTestingDev.xcodeproj","scheme":"CiCdTestingDev","package_name":"cicddev-ios"}]'
          else
            # Otherwise, only add projects that changed
            if [ "${{ needs.detect-changes.outputs.cicdtesting }}" == "true" ]; then
              echo "Adding CiCdTesting to projects"
              projects=$(echo "$projects" | jq -c '. += [{"name":"CiCdTesting","folder":"Apps/CiCdTesting/CiCdTesting/CiCdTesting","project_file":"CiCdTesting.xcodeproj","scheme":"CiCdTesting","package_name":"cicd-ios"}]')
              echo "Projects after adding CiCdTesting: $projects"
            fi
            
            if [ "${{ needs.detect-changes.outputs.cicdtestingdev }}" == "true" ]; then
              echo "Adding CiCdTestingDev to projects"
              projects=$(echo "$projects" | jq -c '. += [{"name":"CiCdTestingDev","folder":"Apps/CiCdTestingDev/CiCdTestingDev/CiCdTestingDev","project_file":"CiCdTestingDev.xcodeproj","scheme":"CiCdTestingDev","package_name":"cicddev-ios"}]')
              echo "Projects after adding CiCdTestingDev: $projects"
            fi
          fi
          
          echo "Final projects: $projects"
          echo "tested-projects=$projects" >> $GITHUB_OUTPUT
          
          project_count=$(echo "$projects" | jq 'length')
          echo "Project count: $project_count"
          
          if [ "$project_count" -gt 0 ]; then
            echo "has-projects=true" >> $GITHUB_OUTPUT
          else
            echo "has-projects=false" >> $GITHUB_OUTPUT
          fi

  deploy:
    needs: [tests, collect-tested]
    if: needs.collect-tested.outputs.has-projects == 'true' && needs.tests.result == 'success' && (github.event_name == 'push' || github.event_name == 'workflow_dispatch')
    strategy:
      matrix:
        project: ${{ fromJson(needs.collect-tested.outputs.tested-projects) }}

    runs-on: macos-latest

    steps:
      - name: Debug matrix project
        run: |
          echo "Full project object: ${{ toJson(matrix.project) }}"
          echo "Project name: ${{ matrix.project.name }}"
          echo "Project folder: ${{ matrix.project.folder }}"
          echo "Project file: ${{ matrix.project.project_file }}"
          echo "Project scheme: ${{ matrix.project.scheme }}"
        
      - uses: actions/checkout@v4

      - name: Select Xcode
        uses: maxim-lobanov/setup-xcode@v1
        with:
          xcode-version: '16.2.0'

      - name: Show build SDK
        run: xcodebuild -showsdks 

      - name: Compute uppercase name
        run: echo "NAME_UPPER=$(echo ${{ matrix.project.name }} | tr '[:lower:]' '[:upper:]')" >> $GITHUB_ENV

      - name: Set dynamic provisioning profile key
        run: echo "PP_KEY=PROVISIONING_PROFILE_${NAME_UPPER}" >> $GITHUB_ENV

      - name: Install the Apple certificate and provisioning profile
        env:
          BUILD_CERTIFICATE_BASE64: ${{ secrets.BUILD_CERTIFICATE_BASE64 }}
          P12_PASSWORD: ${{ secrets.P12_PASSWORD }}
          BUILD_PROVISION_PROFILE_BASE64: ${{ secrets[env.PP_KEY] }}
          KEYCHAIN_PASSWORD: ${{ secrets.KEYCHAIN_PASSWORD }}
        run: |
          CERTIFICATE_PATH=$RUNNER_TEMP/build_certificate.p12
          PP_PATH=$RUNNER_TEMP/build_pp_${{ matrix.project.name }}.mobileprovision
          KEYCHAIN_PATH=$RUNNER_TEMP/app-signing.keychain-db
          
          echo -n "$BUILD_CERTIFICATE_BASE64" | base64 --decode -o $CERTIFICATE_PATH
          echo -n "$BUILD_PROVISION_PROFILE_BASE64" | base64 --decode -o $PP_PATH
          
          security create-keychain -p "$KEYCHAIN_PASSWORD" $KEYCHAIN_PATH
          security set-keychain-settings -lut 21600 $KEYCHAIN_PATH
          security unlock-keychain -p "$KEYCHAIN_PASSWORD" $KEYCHAIN_PATH
          
          security import $CERTIFICATE_PATH -P "$P12_PASSWORD" -A -t cert -f pkcs12 -k $KEYCHAIN_PATH
          security set-key-partition-list -S apple-tool:,apple: -k "$KEYCHAIN_PASSWORD" $KEYCHAIN_PATH
          security list-keychain -d user -s $KEYCHAIN_PATH
          
          mkdir -p ~/Library/MobileDevice/Provisioning\ Profiles

          PROFILE_UUID=$(
          security cms -D -i "$PP_PATH" \
          | plutil -extract UUID raw -
          )

          cp "$PP_PATH" ~/Library/MobileDevice/Provisioning\ Profiles/$PROFILE_UUID.mobileprovision

      - name: Resolve SPM dependencies
        run: |
          cd ${{ matrix.project.folder }}
          xcodebuild -resolvePackageDependencies \
            -project ${{ matrix.project.project_file }} \
            -scheme ${{ matrix.project.scheme }}

      - name: Build and Archive iOS application
        run: |
          cd ${{ matrix.project.folder }}
          cat exportOptions.plist
          
          # Set derived data path for consistency
          DERIVED_DATA="$PWD/DerivedData"
          
          echo "Cleaning previous builds..."
          xcodebuild -skipMacroValidation clean \
            -project ${{ matrix.project.project_file }} \
            -scheme ${{ matrix.project.scheme }} \
            -derivedDataPath "$DERIVED_DATA"
          
          echo "Creating archive..."
          xcodebuild -skipMacroValidation archive \
            -project ${{ matrix.project.project_file }} \
            -scheme ${{ matrix.project.scheme }} \
            -sdk iphoneos \
            -archivePath "$PWD/build/${{ matrix.project.name }}.xcarchive" \
            -derivedDataPath "$DERIVED_DATA" \
            SKIP_INSTALL=NO \
            BUILD_LIBRARY_FOR_DISTRIBUTION=YES | tee build.log
          
          # Check if archive was created successfully
          if [ ! -d "$PWD/build/${{ matrix.project.name }}.xcarchive" ]; then
            echo "Archive was not created. Checking for missing resource bundles..."
            
            # Create missing resource bundles if that's the issue
            BUNDLE_DIR="$DERIVED_DATA/Build/Products/Prod-iphoneos"
            mkdir -p "$BUNDLE_DIR"
            
            if grep -q "swift-sharing_Sharing.bundle" build.log; then
              echo "Creating swift-sharing_Sharing.bundle placeholder..."
              mkdir -p "$BUNDLE_DIR/swift-sharing_Sharing.bundle"
              touch "$BUNDLE_DIR/swift-sharing_Sharing.bundle/.placeholder"
            fi
            
            if grep -q "swift-composable-architecture_ComposableArchitecture.bundle" build.log; then
              echo "Creating swift-composable-architecture_ComposableArchitecture.bundle placeholder..."
              mkdir -p "$BUNDLE_DIR/swift-composable-architecture_ComposableArchitecture.bundle"
              touch "$BUNDLE_DIR/swift-composable-architecture_ComposableArchitecture.bundle/.placeholder"
            fi
            
            # Retry archive with placeholders
            echo "Retrying archive with bundle placeholders..."
            xcodebuild -skipMacroValidation archive \
              -project ${{ matrix.project.project_file }} \
              -scheme ${{ matrix.project.scheme }} \
              -sdk iphoneos \
              -archivePath "$PWD/build/${{ matrix.project.name }}.xcarchive" \
              -derivedDataPath "$DERIVED_DATA" \
              SKIP_INSTALL=NO \
              BUILD_LIBRARY_FOR_DISTRIBUTION=YES
          fi
          
          echo "Exporting archive..."
          xcodebuild -skipMacroValidation -exportArchive \
            -archivePath "$PWD/build/${{ matrix.project.name }}.xcarchive" \
            -exportOptionsPlist "$PWD/exportOptions.plist" \
            -exportPath "$PWD/build"

      - name: Decode App Store Connect private key file
        env:
          API_KEY_BASE64: ${{ secrets.API_KEY_BASE64 }}
          API_KEY: ${{ secrets.KEY_ID }}     
        run: |
          mkdir -p ~/private_keys
          echo -n "$API_KEY_BASE64" | base64 --decode -o ~/private_keys/AuthKey_$API_KEY.p8

      - name: Upload to App Store Connect
        env:
          ISSUER_ID: ${{ secrets.ISSUER_ID }}          
          API_KEY: ${{ secrets.KEY_ID }}     
        run: |
          cd ${{ matrix.project.folder }}
          xcrun altool --upload-app -f build/${{ matrix.project.name }}.ipa -t ios --apiKey $API_KEY --apiIssuer "$ISSUER_ID"

      - name: Clean up keychain and provisioning profile
        if: ${{ always() }}
        run: |
          security delete-keychain $RUNNER_TEMP/app-signing.keychain-db
          rm -f ~/Library/MobileDevice/Provisioning\ Profiles/*.mobileprovision
